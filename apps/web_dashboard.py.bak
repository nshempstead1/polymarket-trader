#!/usr/bin/env python3
"""
Web Dashboard - SQLite-powered trading dashboard

Reads from the trade_journal SQLite database for:
- Decisions (all signal evaluations)
- Trades (executed orders)
- Positions (open/closed with PnL)
- Snapshots (market state at decision time)

Run: python apps/web_dashboard.py
View: http://localhost:8080
"""

import os
import sqlite3
import requests
from datetime import datetime, timezone, timedelta
from pathlib import Path
from flask import Flask, render_template_string, jsonify

app = Flask(__name__)

DB_PATH = "data/trades.db"
WALLET = "0x769Bb0B16c551aA103F8aC7642677DDCc9dd8447"


def get_db():
    """Get database connection."""
    conn = sqlite3.connect(DB_PATH, timeout=5)
    conn.row_factory = sqlite3.Row
    return conn


def get_positions_from_api():
    """Fetch current positions from Polymarket API."""
    try:
        resp = requests.get(
            f"https://data-api.polymarket.com/positions?user={WALLET}",
            timeout=10
        )
        positions = resp.json()
        return [p for p in positions if p.get("currentValue", 0) > 0]
    except Exception as e:
        print(f"Error fetching positions: {e}")
        return []


def get_recent_decisions(limit=50):
    """Get recent decisions from SQLite."""
    try:
        conn = get_db()
        cur = conn.execute("""
            SELECT datetime, strategy, action, market_question, outcome, 
                   signals, result, rejection_reason
            FROM decisions 
            ORDER BY timestamp DESC 
            LIMIT ?
        """, (limit,))
        rows = cur.fetchall()
        conn.close()
        return [dict(r) for r in rows]
    except Exception as e:
        print(f"Error getting decisions: {e}")
        return []


def get_recent_trades(limit=50):
    """Get recent trades from SQLite."""
    try:
        conn = get_db()
        cur = conn.execute("""
            SELECT datetime, strategy, side, price, size_usdc, 
                   market_question, outcome, order_status
            FROM trades 
            ORDER BY timestamp DESC 
            LIMIT ?
        """, (limit,))
        rows = cur.fetchall()
        conn.close()
        return [dict(r) for r in rows]
    except Exception as e:
        print(f"Error getting trades: {e}")
        return []


def get_open_positions():
    """Get open positions from SQLite."""
    try:
        conn = get_db()
        cur = conn.execute("""
            SELECT strategy, entry_price, size_usdc, market_question, 
                   outcome, entry_datetime, peak_price, trough_price
            FROM positions 
            WHERE closed = 0
            ORDER BY entry_time DESC
        """)
        rows = cur.fetchall()
        conn.close()
        return [dict(r) for r in rows]
    except Exception as e:
        print(f"Error getting positions: {e}")
        return []


def get_closed_positions(limit=50):
    """Get closed positions with PnL."""
    try:
        conn = get_db()
        cur = conn.execute("""
            SELECT strategy, entry_price, exit_price, size_usdc, 
                   realized_pnl, exit_reason, market_question, outcome,
                   entry_datetime, exit_datetime,
                   (exit_time - entry_time) / 60.0 as hold_minutes
            FROM positions 
            WHERE closed = 1
            ORDER BY exit_time DESC
            LIMIT ?
        """, (limit,))
        rows = cur.fetchall()
        conn.close()
        return [dict(r) for r in rows]
    except Exception as e:
        print(f"Error getting closed positions: {e}")
        return []


def get_strategy_stats():
    """Get performance stats per strategy."""
    try:
        conn = get_db()
        cur = conn.execute("""
            SELECT 
                strategy,
                COUNT(*) as total_trades,
                SUM(CASE WHEN realized_pnl > 0 THEN 1 ELSE 0 END) as wins,
                SUM(CASE WHEN realized_pnl <= 0 THEN 1 ELSE 0 END) as losses,
                SUM(realized_pnl) as total_pnl,
                AVG(realized_pnl) as avg_pnl,
                SUM(size_usdc) as total_volume
            FROM positions 
            WHERE closed = 1
            GROUP BY strategy
        """)
        rows = cur.fetchall()
        conn.close()
        return {r['strategy']: dict(r) for r in rows}
    except Exception as e:
        print(f"Error getting strategy stats: {e}")
        return {}


def get_daily_stats():
    """Get daily P&L."""
    try:
        conn = get_db()
        cur = conn.execute("""
            SELECT 
                date(exit_datetime) as date,
                COUNT(*) as trades,
                SUM(realized_pnl) as pnl,
                SUM(CASE WHEN realized_pnl > 0 THEN 1 ELSE 0 END) as wins
            FROM positions 
            WHERE closed = 1
            GROUP BY date(exit_datetime)
            ORDER BY date DESC
            LIMIT 30
        """)
        rows = cur.fetchall()
        conn.close()
        return [dict(r) for r in rows]
    except Exception as e:
        print(f"Error getting daily stats: {e}")
        return []


def get_rejection_reasons():
    """Get count of rejection reasons."""
    try:
        conn = get_db()
        cur = conn.execute("""
            SELECT rejection_reason, COUNT(*) as count
            FROM decisions 
            WHERE result = 'rejected' AND rejection_reason IS NOT NULL
            GROUP BY rejection_reason
            ORDER BY count DESC
            LIMIT 20
        """)
        rows = cur.fetchall()
        conn.close()
        return [dict(r) for r in rows]
    except Exception as e:
        print(f"Error getting rejections: {e}")
        return []


HTML_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Polymarket Trading Dashboard</title>
    <meta http-equiv="refresh" content="30">
    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0d1117; color: #c9d1d9; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #58a6ff; border-bottom: 1px solid #30363d; padding-bottom: 10px; margin-bottom: 20px; }
        h2 { color: #8b949e; margin: 25px 0 15px 0; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }
        .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin: 10px 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .stat { text-align: center; padding: 15px; }
        .stat-value { font-size: 32px; font-weight: bold; color: #58a6ff; }
        .stat-label { font-size: 11px; color: #8b949e; text-transform: uppercase; margin-top: 5px; }
        .positive { color: #3fb950 !important; }
        .negative { color: #f85149 !important; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #21262d; }
        th { color: #8b949e; font-weight: 500; font-size: 11px; text-transform: uppercase; }
        tr:hover { background: #1c2128; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .badge-buy { background: #238636; color: white; }
        .badge-sell { background: #da3633; color: white; }
        .badge-pass { background: #6e7681; color: white; }
        .badge-executed { background: #238636; color: white; }
        .badge-rejected { background: #da3633; color: white; }
        .badge-flash { background: #a371f7; color: white; }
        .badge-arb { background: #58a6ff; color: white; }
        .badge-value { background: #3fb950; color: white; }
        .badge-swing { background: #d29922; color: white; }
        .timestamp { color: #6e7681; font-size: 12px; }
        .market-name { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .signals { font-family: monospace; font-size: 11px; color: #8b949e; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { padding: 8px 16px; background: #21262d; border: 1px solid #30363d; border-radius: 6px; color: #8b949e; cursor: pointer; font-size: 13px; }
        .tab.active { background: #58a6ff; color: white; border-color: #58a6ff; }
        .section { display: none; }
        .section.active { display: block; }
        .refresh-note { color: #6e7681; font-size: 11px; float: right; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>ðŸ¤– Polymarket Trading Dashboard <span class="refresh-note">Auto-refresh: 30s</span></h1>
        
        <div class="stats-grid">
            <div class="card stat">
                <div class="stat-value">{{ stats.open_positions }}</div>
                <div class="stat-label">Open Positions</div>
            </div>
            <div class="card stat">
                <div class="stat-value">${{ "%.2f"|format(stats.total_value) }}</div>
                <div class="stat-label">Position Value</div>
            </div>
            <div class="card stat">
                <div class="stat-value {{ 'positive' if stats.total_pnl >= 0 else 'negative' }}">
                    ${{ "%+.2f"|format(stats.total_pnl) }}
                </div>
                <div class="stat-label">Unrealized PnL</div>
            </div>
            <div class="card stat">
                <div class="stat-value {{ 'positive' if stats.realized_pnl >= 0 else 'negative' }}">
                    ${{ "%+.2f"|format(stats.realized_pnl) }}
                </div>
                <div class="stat-label">Realized PnL</div>
            </div>
            <div class="card stat">
                <div class="stat-value">{{ stats.total_trades }}</div>
                <div class="stat-label">Total Trades</div>
            </div>
            <div class="card stat">
                <div class="stat-value">{{ "%.0f"|format(stats.win_rate * 100) }}%</div>
                <div class="stat-label">Win Rate</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="decisions" onclick="showTab('decisions')">ðŸ“‹ Decisions</div>
            <div class="tab" data-tab="trades" onclick="showTab('trades')">ðŸ’° Trades</div>
            <div class="tab" data-tab="positions" onclick="showTab('positions')">ðŸ“ˆ Positions</div>
            <div class="tab" data-tab="strategies" onclick="showTab('strategies')">ðŸŽ¯ Strategies</div>
            <div class="tab" data-tab="rejections" onclick="showTab('rejections')">ðŸš« Rejections</div>
        </div>

        <div id="decisions" class="section active">
            <div class="card">
                <table>
                    <tr>
                        <th>Time</th>
                        <th>Strategy</th>
                        <th>Action</th>
                        <th>Market</th>
                        <th>Result</th>
                        <th>Signals</th>
                    </tr>
                    {% for d in decisions %}
                    <tr>
                        <td class="timestamp">{{ d.datetime[:16] if d.datetime else '' }}</td>
                        <td><span class="badge badge-{{ d.strategy }}">{{ d.strategy }}</span></td>
                        <td><span class="badge badge-{{ d.action|lower }}">{{ d.action }}</span></td>
                        <td class="market-name">{{ (d.market_question or '')[:50] }}...</td>
                        <td><span class="badge badge-{{ d.result }}">{{ d.result }}</span></td>
                        <td class="signals">{{ (d.signals or '')[:60] }}...</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <div id="trades" class="section">
            <div class="card">
                <table>
                    <tr>
                        <th>Time</th>
                        <th>Strategy</th>
                        <th>Side</th>
                        <th>Price</th>
                        <th>Size</th>
                        <th>Market</th>
                        <th>Status</th>
                    </tr>
                    {% for t in trades %}
                    <tr>
                        <td class="timestamp">{{ t.datetime[:16] if t.datetime else '' }}</td>
                        <td><span class="badge badge-{{ t.strategy }}">{{ t.strategy }}</span></td>
                        <td><span class="badge badge-{{ t.side|lower }}">{{ t.side }}</span></td>
                        <td>{{ "%.2f"|format((t.price or 0) * 100) }}Â¢</td>
                        <td>${{ "%.2f"|format(t.size_usdc or 0) }}</td>
                        <td class="market-name">{{ (t.market_question or '')[:40] }}...</td>
                        <td>{{ t.order_status }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <div id="positions" class="section">
            <h2>Open Positions (from API)</h2>
            <div class="card">
                <table>
                    <tr>
                        <th>Market</th>
                        <th>Side</th>
                        <th>Shares</th>
                        <th>Value</th>
                        <th>PnL</th>
                    </tr>
                    {% for p in api_positions %}
                    <tr>
                        <td class="market-name">{{ p.title[:50] }}...</td>
                        <td>{{ p.outcome }}</td>
                        <td>{{ "%.2f"|format(p.size or 0) }}</td>
                        <td>${{ "%.2f"|format(p.currentValue or 0) }}</td>
                        <td class="{{ 'positive' if (p.cashPnl or 0) >= 0 else 'negative' }}">
                            ${{ "%+.2f"|format(p.cashPnl or 0) }}
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>

            <h2>Closed Positions (from Journal)</h2>
            <div class="card">
                <table>
                    <tr>
                        <th>Strategy</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Size</th>
                        <th>PnL</th>
                        <th>Reason</th>
                        <th>Hold Time</th>
                    </tr>
                    {% for p in closed_positions %}
                    <tr>
                        <td><span class="badge badge-{{ p.strategy }}">{{ p.strategy }}</span></td>
                        <td>{{ "%.2f"|format((p.entry_price or 0) * 100) }}Â¢</td>
                        <td>{{ "%.2f"|format((p.exit_price or 0) * 100) }}Â¢</td>
                        <td>${{ "%.2f"|format(p.size_usdc or 0) }}</td>
                        <td class="{{ 'positive' if (p.realized_pnl or 0) >= 0 else 'negative' }}">
                            ${{ "%+.2f"|format(p.realized_pnl or 0) }}
                        </td>
                        <td>{{ p.exit_reason }}</td>
                        <td>{{ "%.0f"|format(p.hold_minutes or 0) }}m</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <div id="strategies" class="section">
            <div class="stats-grid">
                {% for name, s in strategy_stats.items() %}
                <div class="card">
                    <h3 style="color: #58a6ff; margin-bottom: 10px;">{{ name }}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                        <div>Trades: <strong>{{ s.total_trades }}</strong></div>
                        <div>Win Rate: <strong>{{ "%.0f"|format((s.wins or 0) / (s.total_trades or 1) * 100) }}%</strong></div>
                        <div>Total PnL: <strong class="{{ 'positive' if (s.total_pnl or 0) >= 0 else 'negative' }}">${{ "%+.2f"|format(s.total_pnl or 0) }}</strong></div>
                        <div>Avg PnL: <strong>${{ "%.2f"|format(s.avg_pnl or 0) }}</strong></div>
                        <div>Volume: <strong>${{ "%.0f"|format(s.total_volume or 0) }}</strong></div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <h2>Daily P&L</h2>
            <div class="card">
                <table>
                    <tr>
                        <th>Date</th>
                        <th>Trades</th>
                        <th>Wins</th>
                        <th>P&L</th>
                    </tr>
                    {% for d in daily_stats %}
                    <tr>
                        <td>{{ d.date }}</td>
                        <td>{{ d.trades }}</td>
                        <td>{{ d.wins }}</td>
                        <td class="{{ 'positive' if (d.pnl or 0) >= 0 else 'negative' }}">
                            ${{ "%+.2f"|format(d.pnl or 0) }}
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <div id="rejections" class="section">
            <div class="card">
                <table>
                    <tr>
                        <th>Rejection Reason</th>
                        <th>Count</th>
                    </tr>
                    {% for r in rejections %}
                    <tr>
                        <td>{{ r.rejection_reason }}</td>
                        <td>{{ r.count }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <p style="color: #6e7681; font-size: 11px; margin-top: 30px;">
            Last updated: {{ now }} | Wallet: {{ wallet[:10] }}...{{ wallet[-6:] }} | DB: {{ db_path }}
        </p>
    </div>
</body>
</html>
"""


@app.route("/")
def dashboard():
    """Main dashboard page."""
    # Get data from various sources
    api_positions = get_positions_from_api()
    decisions = get_recent_decisions(100)
    trades = get_recent_trades(50)
    closed_positions = get_closed_positions(50)
    strategy_stats = get_strategy_stats()
    daily_stats = get_daily_stats()
    rejections = get_rejection_reasons()
    
    # Calculate summary stats
    total_value = sum(p.get("currentValue", 0) for p in api_positions)
    total_pnl = sum(p.get("cashPnl", 0) for p in api_positions)
    realized_pnl = sum(s.get("total_pnl", 0) or 0 for s in strategy_stats.values())
    total_trades = sum(s.get("total_trades", 0) or 0 for s in strategy_stats.values())
    total_wins = sum(s.get("wins", 0) or 0 for s in strategy_stats.values())
    
    stats = {
        "open_positions": len(api_positions),
        "total_value": total_value,
        "total_pnl": total_pnl,
        "realized_pnl": realized_pnl,
        "total_trades": total_trades,
        "win_rate": total_wins / total_trades if total_trades > 0 else 0
    }
    
    return render_template_string(
        HTML_TEMPLATE,
        stats=stats,
        decisions=decisions,
        trades=trades,
        api_positions=api_positions,
        closed_positions=closed_positions,
        strategy_stats=strategy_stats,
        daily_stats=daily_stats,
        rejections=rejections,
        wallet=WALLET,
        db_path=DB_PATH,
        now=datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")
    )


@app.route("/api/stats")
def api_stats():
    """JSON API for stats."""
    api_positions = get_positions_from_api()
    strategy_stats = get_strategy_stats()
    
    return jsonify({
        "open_positions": len(api_positions),
        "total_value": sum(p.get("currentValue", 0) for p in api_positions),
        "unrealized_pnl": sum(p.get("cashPnl", 0) for p in api_positions),
        "realized_pnl": sum(s.get("total_pnl", 0) or 0 for s in strategy_stats.values()),
        "strategy_stats": strategy_stats,
        "timestamp": datetime.now(timezone.utc).isoformat()
    })


if __name__ == "__main__":
    print("ðŸš€ Dashboard starting at http://0.0.0.0:8080")
    print(f"ðŸ“Š Reading from SQLite: {DB_PATH}")
    app.run(host="0.0.0.0", port=8080, debug=False)
