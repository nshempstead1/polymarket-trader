#!/usr/bin/env python3
"""
Trading Dashboard - Monitor bot performance and analyze trades

Usage:
    # Overview of everything
    python scripts/dashboard.py

    # Detailed strategy breakdown
    python scripts/dashboard.py strategy value_scanner

    # Recent trades with signals
    python scripts/dashboard.py trades --limit 30

    # Decision log (including rejections)
    python scripts/dashboard.py decisions --strategy swing_trader

    # Daily P&L history
    python scripts/dashboard.py daily

    # Why trades got rejected
    python scripts/dashboard.py rejections

    # Export all trades to CSV
    python scripts/dashboard.py export

    # Live monitoring mode (refreshes every 30s)
    python scripts/dashboard.py live
"""

import sys
import time
import argparse
from pathlib import Path
from datetime import datetime, timezone

sys.path.insert(0, str(Path(__file__).parent.parent))

from lib.trade_journal import TradeJournal


C = type('C', (), {
    'G': "\033[92m", 'Y': "\033[93m", 'R': "\033[91m",
    'B': "\033[94m", 'C': "\033[96m", 'M': "\033[95m",
    'BOLD': "\033[1m", 'DIM': "\033[2m", 'RESET': "\033[0m",
})()


def hr(char="─", width=70):
    print(f"{C.DIM}{char * width}{C.RESET}")


def header(title):
    print(f"\n{C.BOLD}{C.B}{'═' * 70}{C.RESET}")
    print(f"{C.BOLD}{C.B}  {title}{C.RESET}")
    print(f"{C.BOLD}{C.B}{'═' * 70}{C.RESET}")


def pnl_color(val):
    if val > 0: return f"{C.G}${val:+.2f}{C.RESET}"
    elif val < 0: return f"{C.R}${val:+.2f}{C.RESET}"
    return f"${val:.2f}"


def pct_color(val):
    if val >= 60: return f"{C.G}{val:.1f}%{C.RESET}"
    elif val >= 40: return f"{C.Y}{val:.1f}%{C.RESET}"
    return f"{C.R}{val:.1f}%{C.RESET}"


def show_overview(journal: TradeJournal):
    """Show complete dashboard overview."""
    header("TRADING BOT DASHBOARD")

    # Overall stats
    stats = journal.get_strategy_stats(days=30)
    print(f"\n{C.BOLD}  30-Day Performance{C.RESET}")
    hr()

    if stats["trades"] == 0:
        print(f"  {C.DIM}No closed trades yet.{C.RESET}")
        print(f"  {C.DIM}Run the bot and check back later.{C.RESET}")

        # Check for open positions
        open_pos = journal.get_open_positions()
        if open_pos:
            print(f"\n{C.BOLD}  Open Positions: {len(open_pos)}{C.RESET}")
            hr()
            for p in open_pos:
                hold_min = (time.time() - p["entry_time"]) / 60
                print(
                    f"  [{p['strategy'][:10]:10s}] {p['outcome'].upper():5s} "
                    f"@ {p['entry_price']:.4f}  ${p['size_usdc']:.2f}  "
                    f"({hold_min:.0f}min)  {p['market_question'][:35]}"
                )
        return

    print(f"  Total Trades:    {stats['trades']}")
    print(f"  Win Rate:        {pct_color(stats['win_rate'])}")
    print(f"  Total PnL:       {pnl_color(stats['total_pnl'])}")
    print(f"  Avg PnL/Trade:   {pnl_color(stats['avg_pnl'])}")
    print(f"  Best Trade:      {pnl_color(stats['best_trade'])}")
    print(f"  Worst Trade:     {pnl_color(stats['worst_trade'])}")
    print(f"  Profit Factor:   {stats['profit_factor']:.2f}")
    print(f"  Avg Hold Time:   {stats['avg_hold_minutes']:.0f} min")

    # Strategy comparison
    comparison = journal.get_strategy_comparison(days=30)
    if len(comparison) > 1:
        print(f"\n{C.BOLD}  Strategy Comparison (30 days){C.RESET}")
        hr()
        print(f"  {'Strategy':<15s} {'Trades':>7s} {'Win%':>7s} {'PnL':>10s} {'Avg':>8s} {'PF':>6s}")
        hr()
        for name, s in sorted(comparison.items(), key=lambda x: x[1].get('total_pnl', 0), reverse=True):
            pf = f"{s['profit_factor']:.1f}" if s['profit_factor'] != float('inf') else "∞"
            print(
                f"  {name:<15s} {s['trades']:>7d} "
                f"{pct_color(s['win_rate']):>17s} "
                f"{pnl_color(s['total_pnl']):>20s} "
                f"{pnl_color(s['avg_pnl']):>18s} "
                f"{pf:>6s}"
            )

    # Open positions
    open_pos = journal.get_open_positions()
    if open_pos:
        print(f"\n{C.BOLD}  Open Positions: {len(open_pos)}{C.RESET}")
        hr()
        for p in open_pos:
            hold_min = (time.time() - p["entry_time"]) / 60
            print(
                f"  [{p['strategy'][:10]:10s}] {p['outcome'].upper():5s} "
                f"@ {p['entry_price']:.4f}  ${p['size_usdc']:.2f}  "
                f"({hold_min:.0f}min)  {p['market_question'][:35]}"
            )

    # Recent trades
    recent = journal.get_recent_trades(limit=5)
    if recent:
        print(f"\n{C.BOLD}  Last 5 Trades{C.RESET}")
        hr()
        for t in recent:
            hold = t.get("hold_time_seconds", 0) or 0
            hold_str = f"{hold/60:.0f}min" if hold < 3600 else f"{hold/3600:.1f}hr"
            print(
                f"  [{t['strategy'][:10]:10s}] {t['outcome'].upper():5s} "
                f"{t['entry_price']:.4f}→{t.get('exit_price', 0):.4f}  "
                f"{pnl_color(t.get('realized_pnl', 0)):>18s}  "
                f"{hold_str:>7s}  {t.get('exit_reason', ''):10s}  "
                f"{t['market_question'][:30]}"
            )

    # Daily stats
    daily = journal.get_daily_stats(days=7)
    if daily:
        print(f"\n{C.BOLD}  Daily PnL (last 7 days){C.RESET}")
        hr()
        for d in daily:
            wr = d["winning_trades"] / d["total_trades"] * 100 if d["total_trades"] > 0 else 0
            print(
                f"  {d['date']}  "
                f"Trades: {d['total_trades']:>3d}  "
                f"Win: {pct_color(wr):>15s}  "
                f"PnL: {pnl_color(d['total_pnl']):>18s}  "
                f"Best: {pnl_color(d['best_trade']):>16s}  "
                f"Worst: {pnl_color(d['worst_trade']):>16s}"
            )

    print()


def show_strategy(journal: TradeJournal, strategy: str):
    """Show detailed stats for one strategy."""
    header(f"Strategy: {strategy}")

    stats = journal.get_strategy_stats(strategy, days=30)
    if stats["trades"] == 0:
        print(f"\n  {C.DIM}No closed trades for this strategy.{C.RESET}\n")
        return

    print(f"\n  Trades: {stats['trades']}  |  W/L: {stats['winning']}/{stats['losing']}  |  Win Rate: {pct_color(stats['win_rate'])}")
    print(f"  Total PnL: {pnl_color(stats['total_pnl'])}  |  Avg: {pnl_color(stats['avg_pnl'])}  |  PF: {stats['profit_factor']:.2f}")
    print(f"  Avg Win: {pnl_color(stats['avg_win'])}  |  Avg Loss: {pnl_color(stats['avg_loss'])}")
    print(f"  Avg Hold: {stats['avg_hold_minutes']:.0f}min  |  Max Hold: {stats['max_hold_minutes']:.0f}min")

    # Recent trades for this strategy
    recent = journal.get_recent_trades(limit=20, strategy=strategy)
    if recent:
        print(f"\n{C.BOLD}  Recent Trades{C.RESET}")
        hr()
        for t in recent:
            hold = t.get("hold_time_seconds", 0) or 0
            hold_str = f"{hold/60:.0f}m"
            signals = ""
            if t.get("entry_signals"):
                import json
                try:
                    sig = json.loads(t["entry_signals"])
                    signals = "  ".join(f"{k}={v}" for k, v in list(sig.items())[:3])
                except Exception:
                    pass

            print(
                f"  {t['outcome'].upper():5s} "
                f"{t['entry_price']:.4f}→{t.get('exit_price', 0):.4f}  "
                f"{pnl_color(t.get('realized_pnl', 0)):>18s}  "
                f"{hold_str:>5s}  "
                f"{t.get('exit_reason', ''):8s}  "
                f"{C.DIM}{signals}{C.RESET}"
            )

    # Decision log
    decisions = journal.get_decision_log(strategy=strategy, limit=10)
    if decisions:
        print(f"\n{C.BOLD}  Recent Decisions{C.RESET}")
        hr()
        for d in decisions:
            result_color = C.G if d["result"] == "executed" else C.R if d["result"] == "rejected" else C.Y
            signals_str = ""
            if d.get("signals"):
                signals_str = "  ".join(f"{k}={v}" for k, v in list(d["signals"].items())[:4])

            dt = d["datetime"][:19] if d.get("datetime") else ""
            print(
                f"  {dt}  "
                f"{d['action']:6s}  "
                f"{result_color}{d['result']:10s}{C.RESET}  "
                f"{d.get('outcome', ''):5s}  "
                f"{C.DIM}{signals_str[:40]}{C.RESET}"
            )
            if d.get("rejection_reason"):
                print(f"    {C.R}→ {d['rejection_reason']}{C.RESET}")

    print()


def show_trades(journal: TradeJournal, limit: int):
    """Show recent trades with full detail."""
    header(f"Recent Trades (last {limit})")

    trades = journal.get_recent_trades(limit=limit)
    if not trades:
        print(f"\n  {C.DIM}No closed trades yet.{C.RESET}\n")
        return

    for t in trades:
        hold = t.get("hold_time_seconds", 0) or 0
        hold_str = f"{hold/60:.0f}min" if hold < 3600 else f"{hold/3600:.1f}hr"
        pnl = t.get("realized_pnl", 0)

        print(f"\n  {C.BOLD}{t['market_question'][:65]}{C.RESET}")
        print(
            f"  [{t['strategy']}]  {t['outcome'].upper()}  "
            f"Entry: {t['entry_price']:.4f}  Exit: {t.get('exit_price', 0):.4f}  "
            f"PnL: {pnl_color(pnl)}  Hold: {hold_str}  "
            f"Reason: {t.get('exit_reason', 'unknown')}"
        )

        if t.get("entry_signals"):
            import json
            try:
                sig = json.loads(t["entry_signals"])
                sig_str = "  ".join(f"{k}={v}" for k, v in sig.items())
                print(f"  {C.DIM}Signals: {sig_str}{C.RESET}")
            except Exception:
                pass

        if t.get("peak_price") and t.get("trough_price"):
            print(
                f"  {C.DIM}Peak: {t['peak_price']:.4f}  "
                f"Trough: {t['trough_price']:.4f}{C.RESET}"
            )

    print()


def show_decisions(journal: TradeJournal, strategy: str, limit: int):
    """Show decision log including rejections."""
    title = f"Decision Log: {strategy}" if strategy else "Decision Log (all)"
    header(title)

    decisions = journal.get_decision_log(strategy=strategy, limit=limit)
    if not decisions:
        print(f"\n  {C.DIM}No decisions logged yet.{C.RESET}\n")
        return

    for d in decisions:
        result_color = C.G if d["result"] == "executed" else C.R if d["result"] == "rejected" else C.Y
        dt = d["datetime"][:19] if d.get("datetime") else ""

        print(
            f"\n  {dt}  [{d['strategy']}]  "
            f"{d['action']:6s}  "
            f"{result_color}{d['result']}{C.RESET}  "
            f"{d.get('outcome', ''):5s}"
        )

        if d.get("market_question"):
            print(f"  {C.DIM}{d['market_question'][:65]}{C.RESET}")

        if d.get("signals"):
            for k, v in d["signals"].items():
                print(f"    {k}: {v}")

        if d.get("rejection_reason"):
            print(f"  {C.R}Rejected: {d['rejection_reason']}{C.RESET}")

    print()


def show_daily(journal: TradeJournal, days: int):
    """Show daily P&L breakdown."""
    header(f"Daily Performance (last {days} days)")

    daily = journal.get_daily_stats(days=days)
    if not daily:
        print(f"\n  {C.DIM}No daily stats yet.{C.RESET}\n")
        return

    cumulative = 0
    print(f"\n  {'Date':<12s} {'Trades':>7s} {'W/L':>7s} {'Win%':>7s} {'PnL':>10s} {'Cumul':>10s} {'Best':>9s} {'Worst':>9s}")
    hr()

    for d in reversed(daily):  # Chronological
        wr = d["winning_trades"] / d["total_trades"] * 100 if d["total_trades"] > 0 else 0
        cumulative += d["total_pnl"]
        wl = f"{d['winning_trades']}/{d['losing_trades']}"

        print(
            f"  {d['date']:<12s} "
            f"{d['total_trades']:>7d} "
            f"{wl:>7s} "
            f"{pct_color(wr):>17s} "
            f"{pnl_color(d['total_pnl']):>20s} "
            f"{pnl_color(cumulative):>20s} "
            f"{pnl_color(d['best_trade']):>19s} "
            f"{pnl_color(d['worst_trade']):>19s}"
        )

    print()


def show_rejections(journal: TradeJournal):
    """Show why trades got rejected."""
    header("Trade Rejections (last 7 days)")

    rejections = journal.get_rejection_stats(days=7)
    if not rejections:
        print(f"\n  {C.G}No rejections in the last 7 days.{C.RESET}\n")
        return

    total = sum(rejections.values())
    print(f"\n  Total rejections: {total}\n")

    for reason, count in sorted(rejections.items(), key=lambda x: x[1], reverse=True):
        pct = count / total * 100
        bar = "█" * int(pct / 2)
        print(f"  {count:>5d} ({pct:4.1f}%)  {C.DIM}{bar}{C.RESET}  {reason}")

    print()


def show_equity_curve(journal: TradeJournal):
    """Show ASCII equity curve."""
    header("Equity Curve (30 days)")

    curve = journal.get_equity_curve(days=30)
    if not curve:
        print(f"\n  {C.DIM}No data for equity curve.{C.RESET}\n")
        return

    # Simple ASCII chart
    values = [c["cumulative_pnl"] for c in curve]
    if not values:
        return

    max_val = max(values)
    min_val = min(values)
    range_val = max_val - min_val if max_val != min_val else 1
    width = 50

    print(f"\n  Max: {pnl_color(max_val)}  Min: {pnl_color(min_val)}  Current: {pnl_color(values[-1])}\n")

    # Sample down to ~20 points for display
    step = max(1, len(values) // 20)
    sampled = values[::step]

    for val in sampled:
        normalized = int((val - min_val) / range_val * width) if range_val else width // 2
        zero_pos = int((0 - min_val) / range_val * width) if range_val else 0
        color = C.G if val >= 0 else C.R

        bar = " " * min(normalized, zero_pos) + color + "█" * abs(normalized - zero_pos) + C.RESET
        print(f"  {val:>+8.2f} |{bar}")

    print()


def live_monitor(journal: TradeJournal):
    """Live monitoring mode - refreshes every 30s."""
    print(f"{C.Y}Live monitoring mode. Press Ctrl+C to exit.{C.RESET}")

    while True:
        try:
            print("\033[2J\033[H")  # Clear screen
            show_overview(journal)
            print(f"\n  {C.DIM}Last updated: {datetime.now().strftime('%H:%M:%S')}  (refreshing in 30s){C.RESET}")
            time.sleep(30)
        except KeyboardInterrupt:
            break


def main():
    parser = argparse.ArgumentParser(description="Trading Bot Dashboard")
    parser.add_argument("--db", default="data/trades.db", help="Path to trade database")

    subparsers = parser.add_subparsers(dest="command")

    # Default: overview
    subparsers.add_parser("overview", help="Full dashboard overview")

    # Strategy detail
    strat = subparsers.add_parser("strategy", help="Strategy deep dive")
    strat.add_argument("name", help="Strategy name")

    # Trades
    trades = subparsers.add_parser("trades", help="Recent trades")
    trades.add_argument("--limit", type=int, default=20)

    # Decisions
    dec = subparsers.add_parser("decisions", help="Decision log")
    dec.add_argument("--strategy", type=str, default=None)
    dec.add_argument("--limit", type=int, default=30)

    # Daily
    daily = subparsers.add_parser("daily", help="Daily P&L")
    daily.add_argument("--days", type=int, default=30)

    # Rejections
    subparsers.add_parser("rejections", help="Rejection analysis")

    # Equity curve
    subparsers.add_parser("equity", help="Equity curve")

    # Export
    exp = subparsers.add_parser("export", help="Export trades to CSV")
    exp.add_argument("--output", default="data/trades_export.csv")

    # Live
    subparsers.add_parser("live", help="Live monitoring mode")

    args = parser.parse_args()
    journal = TradeJournal(args.db)

    if args.command == "strategy":
        show_strategy(journal, args.name)
    elif args.command == "trades":
        show_trades(journal, args.limit)
    elif args.command == "decisions":
        show_decisions(journal, args.strategy, args.limit)
    elif args.command == "daily":
        show_daily(journal, args.days)
    elif args.command == "rejections":
        show_rejections(journal)
    elif args.command == "equity":
        show_equity_curve(journal)
    elif args.command == "export":
        journal.export_csv(args.output)
        print(f"Exported to {args.output}")
    elif args.command == "live":
        live_monitor(journal)
    else:
        show_overview(journal)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nDone.")
    except Exception as e:
        print(f"\n\033[91mError: {e}\033[0m")
        import traceback
        traceback.print_exc()
